<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion de Tr√©sorerie - Cuisines</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #4a6741 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: transparent;
            border: none;
            font-size: 1.1em;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab:hover {
            background: #e9ecef;
            color: #495057;
        }

        .tab.active {
            color: #007bff;
            background: white;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: #007bff;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 4px solid #007bff;
        }

        .form-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 500;
            color: #495057;
            margin-bottom: 8px;
        }

        .form-group input, .form-group select {
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .btn {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .btn-danger:hover {
            box-shadow: 0 5px 15px rgba(220,53,69,0.3);
        }

        .projects-list {
            margin-top: 30px;
        }

        .project-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .project-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .project-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .project-name {
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
        }

        .project-amount {
            font-size: 1.1em;
            font-weight: 600;
            color: #28a745;
        }

        .project-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .detail-value {
            font-weight: 500;
            color: #495057;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #007bff;
        }

        .chart-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #28a745;
        }

        .kpi-value {
            font-size: 2em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .kpi-label {
            color: #6c757d;
            font-weight: 500;
        }

        .cash-flow-chart {
            height: 400px;
            position: relative;
            background: #f8f9fa;
            border-radius: 8px;
            overflow: hidden;
        }

        .chart-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6c757d;
            font-style: italic;
        }

        .positive { color: #28a745 !important; }
        .negative { color: #dc3545 !important; }
        .warning { color: #ffc107 !important; }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .alert-info {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }

        .monthly-flows {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .month-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .month-name {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 10px;
        }

        .month-value {
            font-size: 1.1em;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .project-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ Gestion de Tr√©sorerie</h1>
            <p>Suivi des flux de tr√©sorerie pour projets de cuisines</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="showTab('projects')">üè† Projets</button>
            <button class="tab" onclick="showTab('expenses')">üí∏ Frais Fixes</button>
            <button class="tab" onclick="showTab('forecast')">üìà Pr√©visions</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-value" id="totalRevenue">‚Ç¨0</div>
                    <div class="kpi-label">CA Total</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="currentCash">‚Ç¨0</div>
                    <div class="kpi-label">Tr√©sorerie Actuelle</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="pendingPayments">‚Ç¨0</div>
                    <div class="kpi-label">En Attente</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="activeProjects">0</div>
                    <div class="kpi-label">Projets Actifs</div>
                </div>
            </div>

            <div class="dashboard">
                <div class="chart-container">
                    <div class="chart-title">Flux de Tr√©sorerie sur 24 mois</div>
                    <div class="cash-flow-chart">
                        <canvas id="cashFlowChart" width="100%" height="400"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <div class="chart-title">Tr√©sorerie Mensuelle</div>
                    <div class="monthly-flows" id="monthlyFlows">
                        <!-- Les donn√©es mensuelles seront g√©n√©r√©es ici -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Projects Tab -->
        <div id="projects" class="tab-content">
            <div class="form-section">
                <h3>‚ûï Nouveau Projet</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nom du Projet</label>
                        <input type="text" id="projectName" placeholder="Cuisine Dupont">
                    </div>
                    <div class="form-group">
                        <label>Montant Total (‚Ç¨)</label>
                        <input type="number" id="projectAmount" placeholder="15000">
                    </div>
                    <div class="form-group">
                        <label>Date de Confirmation</label>
                        <input type="date" id="confirmDate">
                    </div>
                    <div class="form-group">
                        <label>Date de Validation</label>
                        <input type="date" id="validationDate">
                    </div>
                    <div class="form-group">
                        <label>Date de Livraison</label>
                        <input type="date" id="deliveryDate">
                    </div>
                    <div class="form-group">
                        <label>Date de Montage</label>
                        <input type="date" id="assemblyDate">
                    </div>
                </div>
                <button class="btn" onclick="addProject()">Ajouter le Projet</button>
            </div>

            <div class="form-section" id="supplierSection" style="display: none;">
                <h3>üöö Gestion Fournisseurs</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Type de Prestation</label>
                        <select id="supplierType">
                            <option value="fourniture">Fourniture</option>
                            <option value="montage">Montage</option>
                            <option value="transport">Transport</option>
                            <option value="autre">Autre</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Nom du Fournisseur</label>
                        <input type="text" id="supplierName" placeholder="Ex: Cuisines Plus">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="supplierDescription" placeholder="Ex: Meubles cuisine ch√™ne">
                    </div>
                    <div class="form-group">
                        <label>Montant (‚Ç¨)</label>
                        <input type="number" id="supplierAmount" placeholder="5000">
                    </div>
                    <div class="form-group">
                        <label>Date d'√âch√©ance</label>
                        <input type="date" id="supplierDueDate">
                    </div>
                    <div class="form-group">
                        <label>Statut</label>
                        <select id="supplierStatus">
                            <option value="pending">√Ä payer</option>
                            <option value="paid">Pay√©</option>
                            <option value="overdue">En retard</option>
                        </select>
                    </div>
                </div>
                <button class="btn" onclick="addSupplierExpense()">Ajouter D√©pense Fournisseur</button>
            </div>

            <div class="projects-list" id="projectsList">
                <!-- Les projets seront affich√©s ici -->
            </div>
        </div>

        <!-- Expenses Tab -->
        <div id="expenses" class="tab-content">
            <div class="form-section">
                <h3>üí∏ Frais Fixes Mensuels</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="expenseName" placeholder="Loyer bureau">
                    </div>
                    <div class="form-group">
                        <label>Montant (‚Ç¨)</label>
                        <input type="number" id="expenseAmount" placeholder="1500">
                    </div>
                </div>
                <button class="btn" onclick="addExpense()">Ajouter Frais Fixe</button>
            </div>

            <div id="expensesList">
                <!-- Les frais fixes seront affich√©s ici -->
            </div>
        </div>

        <!-- Forecast Tab -->
        <div id="forecast" class="tab-content">
            <div class="alert alert-info">
                <strong>üí° Analyse de Tr√©sorerie</strong><br>
                Cette section analyse vos besoins de financement et liquidit√©s sur les 24 prochains mois.
            </div>

            <div class="chart-container">
                <div class="chart-title">Pr√©visions de Tr√©sorerie</div>
                <div id="forecastAnalysis">
                    <!-- L'analyse sera g√©n√©r√©e ici -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let projects = [];
        let expenses = [];

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            updateDashboard();
        });

        // Gestion des onglets
        function showTab(tabName) {
            // Cacher tous les contenus
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Afficher l'onglet s√©lectionn√©
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'dashboard') {
                updateDashboard();
            } else if (tabName === 'forecast') {
                updateForecast();
            }
        }

        // Ajouter un nouveau projet
        function addProject() {
            const name = document.getElementById('projectName').value;
            const amount = parseFloat(document.getElementById('projectAmount').value);
            const confirmDate = document.getElementById('confirmDate').value;
            const validationDate = document.getElementById('validationDate').value;
            const deliveryDate = document.getElementById('deliveryDate').value;
            const assemblyDate = document.getElementById('assemblyDate').value;

            if (!name || !amount || !confirmDate) {
                alert('Veuillez remplir au minimum le nom, montant et date de confirmation');
                return;
            }

            const project = {
                id: Date.now(),
                name,
                amount,
                confirmDate,
                validationDate,
                deliveryDate,
                assemblyDate,
                payments: calculatePayments(amount, confirmDate, validationDate, deliveryDate, assemblyDate),
                suppliers: []
            };

            projects.push(project);
            saveData();
            displayProjects();
            updateDashboard();

            // R√©initialiser le formulaire
            document.getElementById('projectName').value = '';
            document.getElementById('projectAmount').value = '';
            document.getElementById('confirmDate').value = '';
            document.getElementById('validationDate').value = '';
            document.getElementById('deliveryDate').value = '';
            document.getElementById('assemblyDate').value = '';
        }

        // Calculer les √©ch√©ances de paiement
        function calculatePayments(amount, confirmDate, validationDate, deliveryDate, assemblyDate) {
            const payments = [];
            
            // 10% √† la confirmation
            if (confirmDate) {
                payments.push({
                    date: confirmDate,
                    amount: amount * 0.10,
                    description: 'Acompte 1 (10%)',
                    received: false
                });
            }

            // 30% √† la validation
            if (validationDate) {
                payments.push({
                    date: validationDate,
                    amount: amount * 0.30,
                    description: 'Acompte 2 (30%)',
                    received: false
                });
            }

            // 50% √† la livraison
            if (deliveryDate) {
                payments.push({
                    date: deliveryDate,
                    amount: amount * 0.50,
                    description: 'Acompte 3 (50%)',
                    received: false
                });
            }

            // 10% au montage
            if (assemblyDate) {
                payments.push({
                    date: assemblyDate,
                    amount: amount * 0.10,
                    description: 'Solde (10%)',
                    received: false
                });
            }

            return payments;
        }

        // Afficher les projets
        function displayProjects() {
            const container = document.getElementById('projectsList');
            container.innerHTML = '';

            projects.forEach(project => {
                const projectCard = document.createElement('div');
                projectCard.className = 'project-card';
                
                const totalReceived = project.payments.filter(p => p.received).reduce((sum, p) => sum + p.amount, 0);
                const totalPending = project.payments.filter(p => !p.received).reduce((sum, p) => sum + p.amount, 0);

                projectCard.innerHTML = `
                    <div class="project-header">
                        <div class="project-name">${project.name}</div>
                        <div class="project-amount">‚Ç¨${project.amount.toLocaleString()}</div>
                        <button class="btn btn-danger" onclick="deleteProject(${project.id})">üóëÔ∏è</button>
                    </div>
                    <div class="project-details">
                        <div class="detail-item">
                            <div class="detail-label">Confirmation</div>
                            <div class="detail-value">${project.confirmDate ? formatDate(project.confirmDate) : 'Non d√©finie'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Validation</div>
                            <div class="detail-value">${project.validationDate ? formatDate(project.validationDate) : 'Non d√©finie'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Livraison</div>
                            <div class="detail-value">${project.deliveryDate ? formatDate(project.deliveryDate) : 'Non d√©finie'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Montage</div>
                            <div class="detail-value">${project.assemblyDate ? formatDate(project.assemblyDate) : 'Non d√©finie'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Re√ßu</div>
                            <div class="detail-value positive">‚Ç¨${totalReceived.toLocaleString()}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">En attente</div>
                            <div class="detail-value warning">‚Ç¨${totalPending.toLocaleString()}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Co√ªt Fournisseurs</div>
                            <div class="detail-value negative">‚Ç¨${(project.suppliers || []).reduce((sum, s) => sum + s.amount, 0).toLocaleString()}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Marge Brute</div>
                            <div class="detail-value ${(project.amount - (project.suppliers || []).reduce((sum, s) => sum + s.amount, 0)) >= 0 ? 'positive' : 'negative'}">‚Ç¨${(project.amount - (project.suppliers || []).reduce((sum, s) => sum + s.amount, 0)).toLocaleString()}</div>
                        </div>
                    </div>
                    
                    <div class="payments-section">
                        <h4>üì• √âch√©ancier Client</h4>
                        ${project.payments.map(payment => `
                            <div class="payment-item" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin: 5px 0; background: ${payment.received ? '#d4edda' : '#fff3cd'}; border-radius: 5px;">
                                <div>
                                    <strong>${payment.description}</strong> - ${formatDate(payment.date)}<br>
                                    <span style="color: #6c757d;">‚Ç¨${payment.amount.toLocaleString()}</span>
                                </div>
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" ${payment.received ? 'checked' : ''} 
                                           onchange="togglePayment(${project.id}, '${payment.date}', '${payment.description}')">
                                    ${payment.received ? 'Re√ßu' : 'En attente'}
                                </label>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="suppliers-section" style="margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4>üöö D√©penses Fournisseurs</h4>
                            <button class="btn" onclick="showSupplierForm(${project.id})" style="padding: 8px 15px; font-size: 0.9em;">+ Ajouter</button>
                        </div>
                        ${(project.suppliers || []).map(supplier => `
                            <div class="supplier-item" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin: 5px 0; background: ${supplier.status === 'paid' ? '#d4edda' : supplier.status === 'overdue' ? '#f8d7da' : '#fff3cd'}; border-radius: 5px; border-left: 4px solid ${supplier.status === 'paid' ? '#28a745' : supplier.status === 'overdue' ? '#dc3545' : '#ffc107'};">
                                <div style="flex-grow: 1;">
                                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 5px;">
                                        <span style="background: #007bff; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">
                                            ${supplier.type === 'fourniture' ? 'üì¶' : supplier.type === 'montage' ? 'üîß' : supplier.type === 'transport' ? 'üöö' : 'üìã'} 
                                            ${supplier.type.charAt(0).toUpperCase() + supplier.type.slice(1)}
                                        </span>
                                        <strong>${supplier.name}</strong>
                                    </div>
                                    <div style="color: #6c757d; font-size: 0.9em;">${supplier.description}</div>
                                    <div style="margin-top: 5px;">
                                        <span style="font-weight: 600;">‚Ç¨${supplier.amount.toLocaleString()}</span> - 
                                        <span style="color: #6c757d;">√âch√©ance: ${formatDate(supplier.dueDate)}</span>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <select onchange="updateSupplierStatus(${project.id}, ${supplier.id}, this.value)" style="padding: 5px; border-radius: 5px; border: 1px solid #ddd;">
                                        <option value="pending" ${supplier.status === 'pending' ? 'selected' : ''}>√Ä payer</option>
                                        <option value="paid" ${supplier.status === 'paid' ? 'selected' : ''}>Pay√©</option>
                                        <option value="overdue" ${supplier.status === 'overdue' ? 'selected' : ''}>En retard</option>
                                    </select>
                                    <button onclick="deleteSupplier(${project.id}, ${supplier.id})" style="background: #dc3545; color: white; border: none; padding: 5px 8px; border-radius: 3px; cursor: pointer;">üóëÔ∏è</button>
                                </div>
                            </div>
                        `).join('')}
                        ${(project.suppliers || []).length === 0 ? '<div style="text-align: center; color: #6c757d; font-style: italic; padding: 20px;">Aucune d√©pense fournisseur</div>' : ''}
                    </div>
                `;
                
                container.appendChild(projectCard);
            });
        }

        // Basculer le statut d'un paiement
        function togglePayment(projectId, date, description) {
            const project = projects.find(p => p.id === projectId);
            if (project) {
                const payment = project.payments.find(p => p.date === date && p.description === description);
                if (payment) {
                    payment.received = !payment.received;
                    saveData();
                    displayProjects();
                    updateDashboard();
                }
            }
        }

        // Afficher/masquer le formulaire fournisseur
        function showSupplierForm(projectId) {
            const section = document.getElementById('supplierSection');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
            
            // Stocker l'ID du projet pour lequel on ajoute un fournisseur
            window.currentProjectId = projectId;
            
            // R√©initialiser le formulaire
            document.getElementById('supplierType').value = 'fourniture';
            document.getElementById('supplierName').value = '';
            document.getElementById('supplierDescription').value = '';
            document.getElementById('supplierAmount').value = '';
            document.getElementById('supplierDueDate').value = '';
            document.getElementById('supplierStatus').value = 'pending';
        }

        // Ajouter une d√©pense fournisseur
        function addSupplierExpense() {
            if (!window.currentProjectId) {
                alert('Erreur: aucun projet s√©lectionn√©');
                return;
            }

            const type = document.getElementById('supplierType').value;
            const name = document.getElementById('supplierName').value;
            const description = document.getElementById('supplierDescription').value;
            const amount = parseFloat(document.getElementById('supplierAmount').value);
            const dueDate = document.getElementById('supplierDueDate').value;
            const status = document.getElementById('supplierStatus').value;

            if (!name || !amount || !dueDate) {
                alert('Veuillez remplir tous les champs obligatoires');
                return;
            }

            const project = projects.find(p => p.id === window.currentProjectId);
            if (!project) {
                alert('Projet introuvable');
                return;
            }

            if (!project.suppliers) {
                project.suppliers = [];
            }

            const supplier = {
                id: Date.now(),
                type,
                name,
                description,
                amount,
                dueDate,
                status
            };

            project.suppliers.push(supplier);
            saveData();
            displayProjects();
            updateDashboard();

            // Masquer le formulaire et le r√©initialiser
            document.getElementById('supplierSection').style.display = 'none';
            window.currentProjectId = null;
        }

        // Mettre √† jour le statut d'un fournisseur
        function updateSupplierStatus(projectId, supplierId, newStatus) {
            const project = projects.find(p => p.id === projectId);
            if (project && project.suppliers) {
                const supplier = project.suppliers.find(s => s.id === supplierId);
                if (supplier) {
                    supplier.status = newStatus;
                    saveData();
                    displayProjects();
                    updateDashboard();
                }
            }
        }

        // Supprimer un fournisseur
        function deleteSupplier(projectId, supplierId) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette d√©pense fournisseur ?')) {
                const project = projects.find(p => p.id === projectId);
                if (project && project.suppliers) {
                    project.suppliers = project.suppliers.filter(s => s.id !== supplierId);
                    saveData();
                    displayProjects();
                    updateDashboard();
                }
            }
        }
        function deleteProject(id) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer ce projet ?')) {
                projects = projects.filter(p => p.id !== id);
                saveData();
                displayProjects();
                updateDashboard();
            }
        }

        // Ajouter un frais fixe
        function addExpense() {
            const name = document.getElementById('expenseName').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value);

            if (!name || !amount) {
                alert('Veuillez remplir tous les champs');
                return;
            }

            const expense = {
                id: Date.now(),
                name,
                amount
            };

            expenses.push(expense);
            saveData();
            displayExpenses();
            updateDashboard();

            document.getElementById('expenseName').value = '';
            document.getElementById('expenseAmount').value = '';
        }

        // Afficher les frais fixes
        function displayExpenses() {
            const container = document.getElementById('expensesList');
            container.innerHTML = '';

            expenses.forEach(expense => {
                const expenseCard = document.createElement('div');
                expenseCard.className = 'project-card';
                expenseCard.innerHTML = `
                    <div class="project-header">
                        <div class="project-name">${expense.name}</div>
                        <div class="project-amount negative">-‚Ç¨${expense.amount.toLocaleString()}/mois</div>
                        <button class="btn btn-danger" onclick="deleteExpense(${expense.id})">üóëÔ∏è</button>
                    </div>
                `;
                container.appendChild(expenseCard);
            });
        }

        // Supprimer un frais fixe
        function deleteExpense(id) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer ce frais fixe ?')) {
                expenses = expenses.filter(e => e.id !== id);
                saveData();
                displayExpenses();
                updateDashboard();
            }
        }

        // Mettre √† jour le dashboard
        function updateDashboard() {
            const totalRevenue = projects.reduce((sum, project) => sum + project.amount, 0);
            const totalReceived = projects.reduce((sum, project) => 
                sum + project.payments.filter(p => p.received).reduce((pSum, p) => pSum + p.amount, 0), 0);
            const totalPending = projects.reduce((sum, project) => 
                sum + project.payments.filter(p => !p.received).reduce((pSum, p) => pSum + p.amount, 0), 0);
            
            // Calculer les co√ªts fournisseurs
            const totalSupplierCosts = projects.reduce((sum, project) => 
                sum + (project.suppliers || []).reduce((sSum, s) => sSum + s.amount, 0), 0);
            const unpaidSuppliers = projects.reduce((sum, project) => 
                sum + (project.suppliers || []).filter(s => s.status !== 'paid').reduce((sSum, s) => sSum + s.amount, 0), 0);

            document.getElementById('totalRevenue').textContent = `‚Ç¨${totalRevenue.toLocaleString()}`;
            document.getElementById('currentCash').textContent = `‚Ç¨${(totalReceived - totalSupplierCosts + unpaidSuppliers).toLocaleString()}`;
            document.getElementById('pendingPayments').textContent = `‚Ç¨${totalPending.toLocaleString()}`;
            document.getElementById('activeProjects').textContent = projects.length;

            generateMonthlyFlows();
            drawCashFlowChart();
        }

        // G√©n√©rer les flux mensuels
        function generateMonthlyFlows() {
            const container = document.getElementById('monthlyFlows');
            const monthlyData = {};
            
            // Initialiser 24 mois
            const today = new Date();
            for (let i = 0; i < 24; i++) {
                const date = new Date(today.getFullYear(), today.getMonth() + i, 1);
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthlyData[key] = { income: 0, expenses: 0, net: 0 };
            }

            // Ajouter les revenus des projets
            projects.forEach(project => {
                project.payments.forEach(payment => {
                    if (payment.received) {
                        const date = new Date(payment.date);
                        const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                        if (monthlyData[key]) {
                            monthlyData[key].income += payment.amount;
                        }
                    }
                });
            });

            // Soustraire les paiements fournisseurs
            projects.forEach(project => {
                (project.suppliers || []).forEach(supplier => {
                    if (supplier.status === 'paid') {
                        const date = new Date(supplier.dueDate);
                        const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                        if (monthlyData[key]) {
                            monthlyData[key].expenses += supplier.amount;
                        }
                    }
                });
            });

            // Ajouter les frais fixes
            const monthlyExpenses = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            Object.values(monthlyData).forEach(month => {
                month.expenses += monthlyExpenses;
                month.net = month.income - month.expenses;
            });

            // Afficher les mois
            container.innerHTML = '';
            Object.entries(monthlyData).forEach(([key, data]) => {
                const [year, month] = key.split('-');
                const monthName = new Date(year, month - 1).toLocaleDateString('fr-FR', { month: 'short', year: '2-digit' });
                
                const monthCard = document.createElement('div');
                monthCard.className = 'month-card';
                monthCard.innerHTML = `
                    <div class="month-name">${monthName}</div>
                    <div class="month-value ${data.net >= 0 ? 'positive' : 'negative'}">
                        ‚Ç¨${Math.abs(data.net).toLocaleString()}
                    </div>
                    <div style="font-size: 0.8em; color: #6c757d; margin-top: 5px;">
                        +‚Ç¨${data.income.toLocaleString()}<br>
                        -‚Ç¨${data.expenses.toLocaleString()}
                    </div>
                `;
                container.appendChild(monthCard);
            });
        }

        // Dessiner le graphique de flux de tr√©sorerie
        function drawCashFlowChart() {
            const canvas = document.getElementById('cashFlowChart');
            const ctx = canvas.getContext('2d');
            
            // Calculer les donn√©es cumulatives
            const monthlyData = {};
            const today = new Date();
            
            for (let i = 0; i < 24; i++) {
                const date = new Date(today.getFullYear(), today.getMonth() + i, 1);
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthlyData[key] = { income: 0, expenses: 0 };
            }

            // Calculer les revenus
            projects.forEach(project => {
                project.payments.forEach(payment => {
                    if (payment.received) {
                        const date = new Date(payment.date);
                        const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                        if (monthlyData[key]) {
                            monthlyData[key].income += payment.amount;
                        }
                    }
                });
            });

            // Calculer les frais fixes mensuels
            const monthlyExpenses = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            Object.values(monthlyData).forEach(month => {
                month.expenses = monthlyExpenses;
            });

            // Calculer la tr√©sorerie cumulative
            let cumulativeCash = 0;
            const chartData = [];
            
            Object.entries(monthlyData).forEach(([key, data]) => {
                cumulativeCash += (data.income - data.expenses);
                chartData.push({
                    month: key,
                    cash: cumulativeCash
                });
            });

            // Dessiner le graphique
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            const padding = 40;
            const chartWidth = canvas.width - 2 * padding;
            const chartHeight = canvas.height - 2 * padding;
            
            // Trouver les valeurs min/max
            const maxCash = Math.max(...chartData.map(d => d.cash), 0);
            const minCash = Math.min(...chartData.map(d => d.cash), 0);
            const range = maxCash - minCash || 1;
            
            // Effacer le canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Dessiner la grille
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            
            // Lignes horizontales
            for (let i = 0; i <= 5; i++) {
                const y = padding + (chartHeight * i / 5);
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(padding + chartWidth, y);
                ctx.stroke();
            }
            
            // Ligne z√©ro
            if (minCash < 0 && maxCash > 0) {
                const zeroY = padding + chartHeight - ((0 - minCash) / range) * chartHeight;
                ctx.strokeStyle = '#ff4444';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(padding, zeroY);
                ctx.lineTo(padding + chartWidth, zeroY);
                ctx.stroke();
            }
            
            // Dessiner la courbe
            if (chartData.length > 1) {
                ctx.strokeStyle = '#007bff';
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                chartData.forEach((point, index) => {
                    const x = padding + (index / (chartData.length - 1)) * chartWidth;
                    const y = padding + chartHeight - ((point.cash - minCash) / range) * chartHeight;
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                
                ctx.stroke();
                
                // Dessiner les points
                ctx.fillStyle = '#007bff';
                chartData.forEach((point, index) => {
                    const x = padding + (index / (chartData.length - 1)) * chartWidth;
                    const y = padding + chartHeight - ((point.cash - minCash) / range) * chartHeight;
                    
                    ctx.beginPath();
                    ctx.arc(x, y, 4, 0, 2 * Math.PI);
                    ctx.fill();
                });
            }
            
            // Ajouter les √©tiquettes
            ctx.fillStyle = '#333';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            
            // √âtiquettes des mois (tous les 3 mois)
            for (let i = 0; i < chartData.length; i += 3) {
                const x = padding + (i / (chartData.length - 1)) * chartWidth;
                const [year, month] = chartData[i].month.split('-');
                const monthName = new Date(year, month - 1).toLocaleDateString('fr-FR', { month: 'short' });
                ctx.fillText(monthName, x, canvas.height - 10);
            }
            
            // √âtiquettes des montants
            ctx.textAlign = 'right';
            for (let i = 0; i <= 5; i++) {
                const value = minCash + (range * i / 5);
                const y = padding + chartHeight - (chartHeight * i / 5) + 5;
                ctx.fillText(`‚Ç¨${Math.round(value).toLocaleString()}`, padding - 10, y);
            }
        }

        // Mettre √† jour les pr√©visions
        function updateForecast() {
            const container = document.getElementById('forecastAnalysis');
            
            // Calculer l'analyse de tr√©sorerie
            const monthlyData = {};
            const today = new Date();
            
            for (let i = 0; i < 24; i++) {
                const date = new Date(today.getFullYear(), today.getMonth() + i, 1);
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthlyData[key] = { income: 0, expenses: 0 };
            }

            // Revenus pr√©vus (incluant les paiements non re√ßus)
            projects.forEach(project => {
                project.payments.forEach(payment => {
                    const date = new Date(payment.date);
                    const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    if (monthlyData[key]) {
                        monthlyData[key].income += payment.amount;
                    }
                });
            });

            // Calculer les frais fixes mensuels
            const monthlyFixedExpenses = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            
            // Ajouter les paiements fournisseurs pr√©vus
            projects.forEach(project => {
                (project.suppliers || []).forEach(supplier => {
                    const date = new Date(supplier.dueDate);
                    const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    if (monthlyData[key]) {
                        monthlyData[key].expenses += supplier.amount;
                    }
                });
            });
            
            Object.values(monthlyData).forEach(month => {
                month.expenses += monthlyFixedExpenses;
            });

            // Calculer la tr√©sorerie cumulative pr√©visionnelle
            let currentCash = projects.reduce((sum, project) => 
                sum + project.payments.filter(p => p.received).reduce((pSum, p) => pSum + p.amount, 0), 0);
            
            // Soustraire les paiements fournisseurs d√©j√† effectu√©s
            currentCash -= projects.reduce((sum, project) => 
                sum + (project.suppliers || []).filter(s => s.status === 'paid').reduce((sSum, s) => sSum + s.amount, 0), 0);
            
            let minCash = currentCash;
            let maxCash = currentCash;
            let negativeMonths = 0;
            
            const forecast = [];
            
            Object.entries(monthlyData).forEach(([key, data]) => {
                currentCash += (data.income - data.expenses);
                minCash = Math.min(minCash, currentCash);
                maxCash = Math.max(maxCash, currentCash);
                
                if (currentCash < 0) negativeMonths++;
                
                forecast.push({
                    month: key,
                    cash: currentCash,
                    flow: data.income - data.expenses
                });
            });

            // G√©n√©rer l'analyse
            let analysis = `
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-value ${minCash < 0 ? 'negative' : 'positive'}">‚Ç¨${Math.round(minCash).toLocaleString()}</div>
                        <div class="kpi-label">Tr√©sorerie Minimum</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-value positive">‚Ç¨${Math.round(maxCash).toLocaleString()}</div>
                        <div class="kpi-label">Tr√©sorerie Maximum</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-value ${negativeMonths > 0 ? 'negative' : 'positive'}">${negativeMonths}</div>
                        <div class="kpi-label">Mois D√©ficitaires</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-value">‚Ç¨${Math.round(monthlyExpenses).toLocaleString()}</div>
                        <div class="kpi-label">Charges Mensuelles</div>
                    </div>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <h3>üìã Recommandations</h3>
            `;

            if (minCash < 0) {
                analysis += `
                    <div class="alert" style="background: #f8d7da; border-color: #dc3545; color: #721c24;">
                        <strong>‚ö†Ô∏è Attention :</strong> Votre tr√©sorerie sera n√©gative avec un minimum de ‚Ç¨${Math.round(minCash).toLocaleString()}.
                        Vous aurez besoin d'un financement de ‚Ç¨${Math.round(-minCash).toLocaleString()}.
                    </div>
                `;
            } else {
                analysis += `
                    <div class="alert" style="background: #d4edda; border-color: #28a745; color: #155724;">
                        <strong>‚úÖ Bonne nouvelle :</strong> Votre tr√©sorerie reste positive sur les 24 mois.
                    </div>
                `;
            }

            if (negativeMonths > 6) {
                analysis += `<p><strong>üí° Recommandation :</strong> Envisagez de n√©gocier des acomptes plus √©lev√©s en d√©but de projet ou d'√©taler vos charges fixes.</p>`;
            }

            analysis += `
                    <p><strong>üéØ Points d'attention :</strong></p>
                    <ul>
                        <li>Surveillez les √©ch√©ances de paiement de vos clients</li>
                        <li>Anticipez vos besoins de financement ${minCash < -5000 ? 'importants' : ''}</li>
                        <li>Optimisez le timing de vos projets pour lisser la tr√©sorerie</li>
                        ${monthlyExpenses > 3000 ? '<li>Vos charges fixes sont √©lev√©es, cherchez des √©conomies possibles</li>' : ''}
                    </ul>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <h3>üìä D√©tail mensuel des 6 prochains mois</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px;">
            `;

            forecast.slice(0, 6).forEach(month => {
                const [year, monthNum] = month.month.split('-');
                const monthName = new Date(year, monthNum - 1).toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
                
                analysis += `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-weight: 600; margin-bottom: 10px;">${monthName}</div>
                        <div style="color: ${month.flow >= 0 ? '#28a745' : '#dc3545'}; font-size: 1.1em; font-weight: 600;">
                            ${month.flow >= 0 ? '+' : ''}‚Ç¨${Math.round(month.flow).toLocaleString()}
                        </div>
                        <div style="font-size: 0.9em; color: #6c757d; margin-top: 5px;">
                            Tr√©so: ‚Ç¨${Math.round(month.cash).toLocaleString()}
                        </div>
                    </div>
                `;
            });

            analysis += '</div></div>';
            
            container.innerHTML = analysis;
        }

        // Utilitaires
        function formatDate(dateString) {
            if (!dateString) return 'Non d√©finie';
            return new Date(dateString + 'T00:00:00').toLocaleDateString('fr-FR');
        }

        function saveData() {
            // Dans un vrai environnement Excel, ces donn√©es seraient sauvegard√©es
            // Ici on simule avec localStorage pour la d√©mo
            const data = { projects, expenses };
            localStorage.setItem('treasuryData', JSON.stringify(data));
        }

        function loadData() {
            // Charger les donn√©es sauvegard√©es
            const saved = localStorage.getItem('treasuryData');
            if (saved) {
                const data = JSON.parse(saved);
                projects = data.projects || [];
                expenses = data.expenses || [];
            }
            
            displayProjects();
            displayExpenses();
        }
    </script>
</body>
</html>
